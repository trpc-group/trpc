1.RPC

RPC 是远端过程调用的简称，其协议通常包含传输协议和编码协议，如下图：

![rpc](images/rpc.png)​​
 
其中传输协议指 RPC header 使用的协议，编码协议指 RPC payload 的协议。

2.新统一 RPC 协议设计上应具备的能力和诉求：

| 能力                   | 诉求                                                                  |
| ---------------------- | --------------------------------------------------------------------- |
| 向前兼容               | 协议设计和实现上应具有可扩展性                                        |
| 高性能                 | 协议的方案选型和具体实现上需要考虑性能问题                            |
| RPC调用方式            | 远程调用像调本地接口一样                                              |
| 请求超时控制           | 请求可以设置超时时间                                                  |
| 插件化支持多种编码协议 | 协议上支持业务数据的序列化类型应该是多样的，比如：protobuf/jce/json/… |
| 支持压缩               | 协议上应该支持可选择对业务编码后的数据进行压缩                        |
| 调用链信息的透传       | 协议上应该提供服务调用链信息透传的能力                                |
| 染色key                | 协议上应该提供染色key在服务间透传的能力                               |
| 认证和鉴权             | 协议上应该提供用户设置自定义鉴权信息的能力                            |
| 透传用户自定义元数据   | 协议上应该支持用户设置自定义元数据和透传的能力                        |
| 流式请求               | 协议上应该能解决大数据包传输的问题，和满足边请求边应答的流式场景      |

3.新统一 RPC 协议的具体设计

支持流式前的trpc协议设计:

![image.png](/uploads/4C8A111DDAE541A98FC023E445F56794/image.png)

支持流式后的trpc协议设计：

![image.png](/uploads/A855B7D9FDBF45D59E51A992EB752BC7/image.png)


主要改动:
1. 固定帧头中的1字节数据协议状态，含义修改，变成流式帧类型
2. 流式id从2字节变成4字节，保留字段由原来的4字节变成2字节{{image.png}}
3. 流式协议下固定帧头的包头大小设置为0

协议头的字段使用 pb v3 版本定义，参见：[trpc.proto](../proto/trpc.proto)。
